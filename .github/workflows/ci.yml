name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.1

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: TypeScript check
        run: pnpm run typecheck

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.1

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test

      - name: Summarize test run
        run: |
          {
            echo "### Frontend Unit Tests"
            echo
            echo "- Status: ✅ Passed"
          } >> "$GITHUB_STEP_SUMMARY"

  test-e2e-smoke:
    name: E2E Smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.1

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browser
        run: pnpm exec playwright install --with-deps chromium

      - name: Run smoke tests
        run: pnpm run test:e2e:smoke

      - name: Summarize smoke run
        run: |
          {
            echo "### E2E Smoke Tests"
            echo
            echo "- Status: ✅ Passed"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          if-no-files-found: ignore
          retention-days: 14

  coverage-frontend:
    name: Frontend Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.1

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run coverage
        run: pnpm vitest run --coverage --coverage.reporter=lcov --coverage.reporter=text-summary --coverage.reportsDirectory=coverage/frontend

      - name: Summarize coverage
        run: |
          node <<'NODE'
          const fs = require('node:fs');
          const lcovPath = 'coverage/frontend/lcov.info';
          if (!fs.existsSync(lcovPath)) {
            console.error('Missing lcov report at ' + lcovPath);
            process.exit(1);
          }
          const lines = fs.readFileSync(lcovPath, 'utf8').split('\n');
          let lf = 0;
          let lh = 0;
          for (const line of lines) {
            if (line.startsWith('LF:')) lf += Number(line.slice(3));
            if (line.startsWith('LH:')) lh += Number(line.slice(3));
          }
          const pct = lf > 0 ? (lh / lf) * 100 : 0;
          fs.appendFileSync(
            process.env.GITHUB_STEP_SUMMARY,
            `### Frontend Coverage\n\n- Line coverage: **${pct.toFixed(2)}%** (${lh}/${lf})\n`
          );
          fs.writeFileSync(
            'coverage/frontend/summary.json',
            JSON.stringify({ line_total: lf, line_hit: lh, line_pct: pct }, null, 2)
          );
          NODE

      - name: Enforce frontend coverage floor (optional)
        if: ${{ vars.FRONTEND_COVERAGE_MIN != '' }}
        env:
          FRONTEND_COVERAGE_MIN: ${{ vars.FRONTEND_COVERAGE_MIN }}
        run: |
          node <<'NODE'
          const fs = require('node:fs');
          const summary = JSON.parse(fs.readFileSync('coverage/frontend/summary.json', 'utf8'));
          const min = Number(process.env.FRONTEND_COVERAGE_MIN);
          if (Number.isNaN(min)) {
            console.error('FRONTEND_COVERAGE_MIN is not a number');
            process.exit(1);
          }
          if (summary.line_pct < min) {
            console.error(`Frontend coverage ${summary.line_pct.toFixed(2)}% is below required ${min}%`);
            process.exit(1);
          }
          console.log(`Frontend coverage gate passed: ${summary.line_pct.toFixed(2)}% >= ${min}%`);
          NODE

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: coverage/frontend
          if-no-files-found: error
          retention-days: 14

  check-backend:
    name: Check & Test Backend
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: brew install protobuf

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy, llvm-tools-preview

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Create frontend dist stub
        run: mkdir -p dist && echo '<html></html>' > dist/index.html

      - name: Check formatting
        working-directory: src-tauri
        run: cargo fmt --check

      - name: Clippy
        working-directory: src-tauri
        run: cargo clippy -- -D warnings

      - name: Run tests
        working-directory: src-tauri
        run: cargo test

  coverage-backend:
    name: Backend Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y pkg-config libssl-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Create frontend dist stub
        run: mkdir -p dist && echo '<html></html>' > dist/index.html

      - name: Install llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Create coverage directory
        run: mkdir -p coverage/backend

      - name: Run coverage
        working-directory: src-tauri
        run: cargo llvm-cov --workspace --lcov --output-path ../coverage/backend/lcov.info

      - name: Summarize coverage
        run: |
          node <<'NODE'
          const fs = require('node:fs');
          const lcovPath = 'coverage/backend/lcov.info';
          if (!fs.existsSync(lcovPath)) {
            console.error('Missing lcov report at ' + lcovPath);
            process.exit(1);
          }
          const lines = fs.readFileSync(lcovPath, 'utf8').split('\n');
          let lf = 0;
          let lh = 0;
          for (const line of lines) {
            if (line.startsWith('LF:')) lf += Number(line.slice(3));
            if (line.startsWith('LH:')) lh += Number(line.slice(3));
          }
          const pct = lf > 0 ? (lh / lf) * 100 : 0;
          fs.appendFileSync(
            process.env.GITHUB_STEP_SUMMARY,
            `### Backend Coverage\n\n- Line coverage: **${pct.toFixed(2)}%** (${lh}/${lf})\n`
          );
          fs.writeFileSync(
            'coverage/backend/summary.json',
            JSON.stringify({ line_total: lf, line_hit: lh, line_pct: pct }, null, 2)
          );
          NODE

      - name: Enforce backend coverage floor (optional)
        if: ${{ vars.BACKEND_COVERAGE_MIN != '' }}
        env:
          BACKEND_COVERAGE_MIN: ${{ vars.BACKEND_COVERAGE_MIN }}
        run: |
          node <<'NODE'
          const fs = require('node:fs');
          const summary = JSON.parse(fs.readFileSync('coverage/backend/summary.json', 'utf8'));
          const min = Number(process.env.BACKEND_COVERAGE_MIN);
          if (Number.isNaN(min)) {
            console.error('BACKEND_COVERAGE_MIN is not a number');
            process.exit(1);
          }
          if (summary.line_pct < min) {
            console.error(`Backend coverage ${summary.line_pct.toFixed(2)}% is below required ${min}%`);
            process.exit(1);
          }
          console.log(`Backend coverage gate passed: ${summary.line_pct.toFixed(2)}% >= ${min}%`);
          NODE

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: coverage/backend
          if-no-files-found: error
          retention-days: 14

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.1

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        run: pnpm audit --audit-level high

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install cargo-audit
        uses: taiki-e/install-action@cargo-audit

      - name: Run cargo audit
        working-directory: src-tauri
        run: cargo audit

      - name: Summarize security audit
        run: |
          {
            echo "### Security Audit"
            echo
            echo "- pnpm audit: ✅ Passed (high severity threshold)"
            echo "- cargo audit: ✅ Passed"
          } >> "$GITHUB_STEP_SUMMARY"

  build:
    name: Build (macOS)
    runs-on: macos-latest
    needs: [lint-frontend, test-frontend, test-e2e-smoke, coverage-frontend, check-backend, coverage-backend, security-audit]
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: brew install protobuf

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.1

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        run: pnpm run build

      - name: Build Tauri app
        run: pnpm tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
