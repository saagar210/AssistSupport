name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: TypeScript check
        run: pnpm run typecheck

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test

      - name: Summarize test run
        run: |
          {
            echo "### Frontend Unit Tests"
            echo
            echo "- Status: ✅ Passed"
          } >> "$GITHUB_STEP_SUMMARY"

  memorykernel-contract:
    name: MemoryKernel Contract Gate
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce pin/matrix/manifest sync updates
        shell: bash
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          if [[ -z "$BASE_SHA" ]]; then
            BASE_SHA="${{ github.event.before }}"
          fi

          if [[ -z "$BASE_SHA" || "$BASE_SHA" == "0000000000000000000000000000000000000000" ]]; then
            echo "No valid base SHA available; skipping pin diff policy check."
            exit 0
          fi

          CHANGED_FILES="$(git diff --name-only "$BASE_SHA" "${{ github.sha }}")"
          PIN_FILE="config/memorykernel-integration-pin.json"
          MATRIX_FILE="docs/MEMORYKERNEL_COMPATIBILITY_MATRIX.md"
          MANIFEST_FILE="config/memorykernel-producer-manifest.json"

          PIN_CHANGED=0
          MATRIX_CHANGED=0
          MANIFEST_CHANGED=0

          if echo "$CHANGED_FILES" | grep -Eq "^${PIN_FILE}$"; then
            PIN_CHANGED=1
          fi
          if echo "$CHANGED_FILES" | grep -Eq "^${MATRIX_FILE}$"; then
            MATRIX_CHANGED=1
          fi
          if echo "$CHANGED_FILES" | grep -Eq "^${MANIFEST_FILE}$"; then
            MANIFEST_CHANGED=1
          fi

          if [[ "$PIN_CHANGED" -eq 1 || "$MATRIX_CHANGED" -eq 1 || "$MANIFEST_CHANGED" -eq 1 ]]; then
            if [[ "$PIN_CHANGED" -ne 1 || "$MATRIX_CHANGED" -ne 1 || "$MANIFEST_CHANGED" -ne 1 ]]; then
              echo "MemoryKernel governance files must be updated together in the same PR:"
              echo "- ${PIN_FILE}"
              echo "- ${MATRIX_FILE}"
              echo "- ${MANIFEST_FILE}"
              echo
              echo "Changed files were:"
              echo "$CHANGED_FILES"
              exit 1
            fi
          fi

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create frontend dist stub
        run: mkdir -p dist && echo '<html></html>' > dist/index.html

      - name: Validate MemoryKernel pin + matrix + producer manifest sync
        run: pnpm run check:memorykernel-pin

      - name: Validate MemoryKernel governance bundle
        run: pnpm run check:memorykernel-governance

      - name: Validate remote producer manifest hash (authenticated)
        if: ${{ secrets.MEMORYKERNEL_REPO_READ_TOKEN != '' }}
        env:
          ASSISTSUPPORT_VALIDATE_REMOTE_MANIFEST: '1'
          MEMORYKERNEL_GITHUB_TOKEN: ${{ secrets.MEMORYKERNEL_REPO_READ_TOKEN }}
        run: pnpm run check:memorykernel-pin

      - name: Note remote manifest check status
        if: ${{ secrets.MEMORYKERNEL_REPO_READ_TOKEN == '' }}
        run: |
          {
            echo "### MemoryKernel Manifest Remote Check"
            echo
            echo "- Status: skipped (no \`MEMORYKERNEL_REPO_READ_TOKEN\` configured)"
            echo "- Local manifest hash integrity checks still enforced."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Run MemoryKernel contract tests
        run: pnpm run test:memorykernel-contract

      - name: Summarize MemoryKernel contract evidence
        run: |
          if [[ -f artifacts/memorykernel-contract-evidence.json ]]; then
            echo "### MemoryKernel Contract Evidence" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```json' >> "$GITHUB_STEP_SUMMARY"
            cat artifacts/memorykernel-contract-evidence.json >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Missing artifacts/memorykernel-contract-evidence.json"
            exit 1
          fi

      - name: Upload MemoryKernel contract evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: memorykernel-contract-evidence
          path: artifacts/memorykernel-contract-evidence.json
          if-no-files-found: error
          retention-days: 14

  memorykernel-monorepo:
    name: MemoryKernel Monorepo Gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Run MemoryKernel monorepo suite
        working-directory: services/memorykernel
        run: |
          cargo fmt --all -- --check
          cargo clippy --workspace --all-targets --all-features -- -D warnings
          cargo test --workspace --all-targets --all-features
          ./scripts/verify_service_contract_alignment.sh --memorykernel-root "$(pwd)"
          ./scripts/verify_service_contract_source_of_truth.sh --memorykernel-root "$(pwd)"
          ./scripts/verify_contract_parity.sh --canonical-root "$(pwd)"
          ./scripts/verify_trilogy_compatibility_artifacts.sh --memorykernel-root "$(pwd)"
          ./scripts/run_trilogy_smoke.sh --memorykernel-root "$(pwd)"
          ./scripts/run_trilogy_compliance_suite.sh --memorykernel-root "$(pwd)" --skip-baseline
          ./scripts/verify_service_slo_policy.sh --memorykernel-root "$(pwd)"
          ./scripts/verify_producer_contract_manifest.sh --memorykernel-root "$(pwd)"
          ./scripts/verify_producer_handoff_payload.sh --memorykernel-root "$(pwd)"
          ./scripts/verify_release_evidence_bundle.sh --memorykernel-root "$(pwd)"

  monorepo-governance:
    name: Monorepo Governance Gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify workstation preflight contract
        run: pnpm run check:workstation-preflight

      - name: Run monorepo governance checks
        run: |
          pnpm run check:memorykernel-pin
          pnpm run check:memorykernel-governance
          pnpm run check:memorykernel-handoff
          pnpm run check:memorykernel-handoff:service-v3-candidate
          pnpm run check:memorykernel-boundary
          pnpm run check:memorykernel-cutover-policy

  test-e2e-smoke:
    name: E2E Smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browser
        run: pnpm exec playwright install --with-deps chromium

      - name: Run smoke tests
        run: pnpm run test:e2e:smoke

      - name: Summarize smoke run
        run: |
          {
            echo "### E2E Smoke Tests"
            echo
            echo "- Status: ✅ Passed"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          if-no-files-found: ignore
          retention-days: 14

  coverage-frontend:
    name: Frontend Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run coverage
        run: pnpm vitest run --coverage --coverage.reporter=lcov --coverage.reporter=text-summary --coverage.reportsDirectory=coverage/frontend

      - name: Summarize coverage
        run: |
          node <<'NODE'
          const fs = require('node:fs');
          const lcovPath = 'coverage/frontend/lcov.info';
          if (!fs.existsSync(lcovPath)) {
            console.error('Missing lcov report at ' + lcovPath);
            process.exit(1);
          }
          const lines = fs.readFileSync(lcovPath, 'utf8').split('\n');
          let lf = 0;
          let lh = 0;
          for (const line of lines) {
            if (line.startsWith('LF:')) lf += Number(line.slice(3));
            if (line.startsWith('LH:')) lh += Number(line.slice(3));
          }
          const pct = lf > 0 ? (lh / lf) * 100 : 0;
          fs.appendFileSync(
            process.env.GITHUB_STEP_SUMMARY,
            `### Frontend Coverage\n\n- Line coverage: **${pct.toFixed(2)}%** (${lh}/${lf})\n`
          );
          fs.writeFileSync(
            'coverage/frontend/summary.json',
            JSON.stringify({ line_total: lf, line_hit: lh, line_pct: pct }, null, 2)
          );
          NODE

      - name: Enforce frontend coverage floor (optional)
        if: ${{ vars.FRONTEND_COVERAGE_MIN != '' }}
        env:
          FRONTEND_COVERAGE_MIN: ${{ vars.FRONTEND_COVERAGE_MIN }}
        run: |
          node <<'NODE'
          const fs = require('node:fs');
          const summary = JSON.parse(fs.readFileSync('coverage/frontend/summary.json', 'utf8'));
          const min = Number(process.env.FRONTEND_COVERAGE_MIN);
          if (Number.isNaN(min)) {
            console.error('FRONTEND_COVERAGE_MIN is not a number');
            process.exit(1);
          }
          if (summary.line_pct < min) {
            console.error(`Frontend coverage ${summary.line_pct.toFixed(2)}% is below required ${min}%`);
            process.exit(1);
          }
          console.log(`Frontend coverage gate passed: ${summary.line_pct.toFixed(2)}% >= ${min}%`);
          NODE

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: coverage/frontend
          if-no-files-found: error
          retention-days: 14

  check-backend:
    name: Check & Test Backend
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: brew install protobuf

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy, llvm-tools-preview

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Create frontend dist stub
        run: mkdir -p dist && echo '<html></html>' > dist/index.html

      - name: Check formatting
        working-directory: src-tauri
        run: cargo fmt --check

      - name: Clippy
        working-directory: src-tauri
        run: cargo clippy -- -D warnings

      - name: Run tests
        working-directory: src-tauri
        run: cargo test

  coverage-backend:
    name: Backend Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            curl \
            file \
            libssl-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libsoup-3.0-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libxdo-dev \
            patchelf \
            pkg-config \
            protobuf-compiler \
            wget

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Create frontend dist stub
        run: mkdir -p dist && echo '<html></html>' > dist/index.html

      - name: Install llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Create coverage directory
        run: mkdir -p coverage/backend

      - name: Run coverage
        working-directory: src-tauri
        run: cargo llvm-cov --workspace --lcov --output-path ../coverage/backend/lcov.info

      - name: Summarize coverage
        run: |
          node <<'NODE'
          const fs = require('node:fs');
          const lcovPath = 'coverage/backend/lcov.info';
          if (!fs.existsSync(lcovPath)) {
            console.error('Missing lcov report at ' + lcovPath);
            process.exit(1);
          }
          const lines = fs.readFileSync(lcovPath, 'utf8').split('\n');
          let lf = 0;
          let lh = 0;
          for (const line of lines) {
            if (line.startsWith('LF:')) lf += Number(line.slice(3));
            if (line.startsWith('LH:')) lh += Number(line.slice(3));
          }
          const pct = lf > 0 ? (lh / lf) * 100 : 0;
          fs.appendFileSync(
            process.env.GITHUB_STEP_SUMMARY,
            `### Backend Coverage\n\n- Line coverage: **${pct.toFixed(2)}%** (${lh}/${lf})\n`
          );
          fs.writeFileSync(
            'coverage/backend/summary.json',
            JSON.stringify({ line_total: lf, line_hit: lh, line_pct: pct }, null, 2)
          );
          NODE

      - name: Enforce backend coverage floor (optional)
        if: ${{ vars.BACKEND_COVERAGE_MIN != '' }}
        env:
          BACKEND_COVERAGE_MIN: ${{ vars.BACKEND_COVERAGE_MIN }}
        run: |
          node <<'NODE'
          const fs = require('node:fs');
          const summary = JSON.parse(fs.readFileSync('coverage/backend/summary.json', 'utf8'));
          const min = Number(process.env.BACKEND_COVERAGE_MIN);
          if (Number.isNaN(min)) {
            console.error('BACKEND_COVERAGE_MIN is not a number');
            process.exit(1);
          }
          if (summary.line_pct < min) {
            console.error(`Backend coverage ${summary.line_pct.toFixed(2)}% is below required ${min}%`);
            process.exit(1);
          }
          console.log(`Backend coverage gate passed: ${summary.line_pct.toFixed(2)}% >= ${min}%`);
          NODE

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: coverage/backend
          if-no-files-found: error
          retention-days: 14

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        run: pnpm audit --audit-level high

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install cargo-audit
        uses: taiki-e/install-action@cargo-audit

      - name: Run cargo audit
        working-directory: src-tauri
        run: cargo audit

      - name: Summarize security audit
        run: |
          {
            echo "### Security Audit"
            echo
            echo "- pnpm audit: ✅ Passed (high severity threshold)"
            echo "- cargo audit: ✅ Passed"
          } >> "$GITHUB_STEP_SUMMARY"

  test-search-api:
    name: Test Search API
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install redis
        run: sudo apt-get update && sudo apt-get install -y redis-server

      - name: Start redis service
        run: sudo service redis-server start

      - name: Install Search API test dependencies
        working-directory: search-api
        run: |
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements-test.txt

      - name: Run Search API tests
        working-directory: search-api
        run: |
          source venv/bin/activate
          pytest -q

      - name: Validate production runtime config
        working-directory: search-api
        env:
          ENVIRONMENT: production
          ASSISTSUPPORT_API_KEY: ci-test-key
          ASSISTSUPPORT_RATE_LIMIT_STORAGE_URI: redis://127.0.0.1:6379/0
          ASSISTSUPPORT_API_PORT: 3390
        run: |
          source venv/bin/activate
          python validate_runtime.py --check-backends --json

      - name: Run Search API production smoke check
        working-directory: search-api
        env:
          ENVIRONMENT: production
          ASSISTSUPPORT_API_KEY: ci-test-key
          ASSISTSUPPORT_RATE_LIMIT_STORAGE_URI: redis://127.0.0.1:6379/0
          ASSISTSUPPORT_API_PORT: 3390
        run: |
          source venv/bin/activate
          python smoke_search_api.py

  build:
    name: Build (macOS)
    runs-on: macos-latest
    needs: [lint-frontend, test-frontend, memorykernel-contract, test-e2e-smoke, coverage-frontend, check-backend, coverage-backend, security-audit, test-search-api]
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: brew install protobuf

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        run: pnpm run build

      - name: Build Tauri app
        run: pnpm tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
